###################
# Test code stage #
###################
# Run the tests, both for noetic and foxy. These stages are separated because they
# are not dependent on eachother. This enables extra parallelization.
.base_tester:
  stage: Test code
  # Depending on the rules below, `TAG` has a different value.
  # In most cases, this will just be `main`, unless the Dockerfile has
  # changed.
  image: $CI_REGISTRY_IMAGE/$ROS_CODENAME:$TAG
#  variables:
#    # Define how submodules are handled. See https://docs.gitlab.com/ee/ci/runners/README.html#git-submodule-strategy
#    GIT_SUBMODULE_STRATEGY: normal
  script:
    - cd $ROS_VERSION/
    - source /opt/ros/$ROS_CODENAME/local_setup.bash && source install/local_setup.bash
    - colcon test --event-handlers console_direct+ --packages-skip joint_state_broadcaster
    - colcon test-result --verbose
  rules:
    # These rules are checking if certain values have the correct values.
    # These variables are predefined by GitLab and their definitions
    # can be found on https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      variables:
        TAG: $CI_COMMIT_REF_NAME
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "$DOCKER_FILE"
        - "$ROS_VERSION/**/package.xml"
        - "requirements.txt"
      variables:
        TAG: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - $DOCKER_FILE
      variables:
        TAG: $CI_COMMIT_BRANCH
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "$ROS_VERSION/**/*"
      variables:
        TAG: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    # The next if is for a MR goes through for a protected branch. (e.g. dev and main)
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - "$ROS_VERSION/**/*"
      variables:
        TAG: $CI_COMMIT_BRANCH

foxy:test:
  variables:
    ROS_VERSION: "ros2"
    ROS_CODENAME: "foxy"
    DOCKER_FILE: ".gitlab/dockerfiles/foxy"
  needs:
    - job: "foxy:build"
      artifacts: true
  extends:
    - .base_tester
